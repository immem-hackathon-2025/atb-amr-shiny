---
title: "ATB_preprocessing"
output: html_document
date: "2025-09-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(dev = 'png', echo = TRUE, message = FALSE, warning = FALSE,
                      cache = FALSE, fig.align = 'center')
knitr::opts_knit$set(root.dir = getwd())

library(tidyverse)
library(readr)

```

# REQUIRES the following files (in the AllTheBacteria folder) that were too large to put into GitHub but can be downloaded from AllTheBacteria:
# ATB_AMRFP_status.tsv.gz (AMRfp completion status)
# ATB_species_calls.tsv.gz (AMRfp species calls with quality call)
# AMRFP_results.tsv.gz (AMRfp results)

# AMRFinderPlus (AMRFP) data (from https://osf.io/zgexh, accessed 15/09/25)
# (via browser, click three dots, download)

```{r }

# load files

atb_armfp_qc_status=read_tsv("AllTheBacteria/ATB_AMRFP_status.tsv.gz")

atb_species_results=read_tsv("AllTheBacteria/ATB_species_calls.tsv.gz")
  

# create an empty vector for sample accessions
combined_sample_accessions <- NULL
  
# get complete list of all sample accessions
temp_sample_accessions <- atb_species_results %>%
      select(Sample) %>%
      unique() %>%
      pull()
    
# Add accessions to character vector
combined_sample_accessions <- c(temp_sample_accessions, combined_sample_accessions)
  
# nested callback function to read in only those lines containing selected taxa (for chuncking)

f <- function(x, pos) subset(x, Name %in% combined_sample_accessions)
  
# read lines of amrfp
selected_atb_amrfp <- read_tsv_chunked(file="AllTheBacteria/AMRFP_results.tsv.gz", callback=DataFrameCallback$new(f), chunk_size = 10000)

# join amrfp with species and qc results 
selected_atb_amrfp <- selected_atb_amrfp %>%
    left_join(atb_species_results, by=c("Name"="Sample")) %>% 
    left_join(atb_armfp_qc_status, by=c("Name"="sample")) 

# filtering amrfp  
atb_amrfp_filtered <- 
selected_atb_amrfp %>%
    filter(`HQ` == TRUE) %>%
    filter(`status`== "PASS") %>%
    select(`Name`,`Gene symbol`, `Hierarchy node`, `Element type`, `Element subtype`, `% Coverage of reference sequence`, `% Identity to reference sequence`, `Method`, `Class`, `Subclass`, `Species`) 

# write file
write_tsv(atb_amrfp_filtered, file=("AllTheBacteria/ATB_AFP_preprocessed.tsv.gz"))
  
```
